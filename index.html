<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禅道兼容需求编辑器</title>
    <!-- 引入 Tailwind CSS 进行页面布局美化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 TinyMCE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="no-referrer"></script>
    <style>
        .tox-tinymce {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        body {
            background-color: #f3f4f6;
        }
        /* 复制成功的动画 */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .toast-visible {
            opacity: 1;
            animation: fadeOut 2s ease-in-out 1s forwards;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style="height: 90vh;">
        <!-- 头部 -->
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-xl font-bold">禅道兼容需求编辑器</h1>
                <p class="text-blue-100 text-sm mt-1">编写内容 -> 一键全选复制 -> 粘贴至禅道</p>
            </div>
            <div class="text-xs bg-blue-700 px-3 py-1 rounded text-blue-200">
                支持：加粗/斜体/下划线/删除线/列表/表格/贴图
            </div>
        </div>

        <!-- 编辑器容器 -->
        <div class="flex-grow p-4 bg-white overflow-hidden flex flex-col">
            <textarea id="mytextarea">
                <p>在此处编写您的需求描述...</p>
                <p><strong>1. 功能点：</strong></p>
                <ul>
                    <li>支持直接截图粘贴 (Ctrl+V)</li>
                    <li>支持表格和列表</li>
                </ul>
            </textarea>
        </div>

        <!-- 底部操作栏 -->
        <div class="bg-gray-50 border-t border-gray-200 p-4 shrink-0 flex justify-end items-center gap-3">
            <span id="msg" class="text-green-600 text-sm font-medium toast-hidden">
                ✅ 已全选并复制！建议先粘贴到 Word 测试是否有图
            </span>
            <button onclick="clearEditor()" class="px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors text-sm font-medium">
                清空内容
            </button>
            <button onclick="copyForZentao()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow transition-transform transform active:scale-95 font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                暴力复制 (Base64)
            </button>
        </div>
    </div>

    <script>
        tinymce.init({
            selector: '#mytextarea',
            height: "100%", 
            resize: false,  
            branding: false, 
            statusbar: true, 
            menubar: false,  
            plugins: 'lists table image link code wordcount',
            toolbar: 'bold italic underline strikethrough | numlist bullist | table image | removeformat code',
            
            // 核心配置：允许 Base64 进出
            paste_data_images: true,
            automatic_uploads: false,
            images_reuse_filename: false,
            
            content_style: `
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #333; }
                table { border-collapse: collapse; width: 100%; }
                table td, table th { border: 1px solid #ccc; padding: 4px 8px; }
                img { max-width: 100%; height: auto; display: block; margin: 4px 0; }
            `,

            table_default_attributes: { border: '1', style: 'border-collapse: collapse; width: 100%; border-color: #ddd;' },
            table_default_styles: { 'border-collapse': 'collapse', 'width': '100%' }
        });

        async function copyForZentao() {
            const editor = tinymce.get('mytextarea');
            if (!editor) return;

            // 1. 获取原始内容
            const rawContent = editor.getContent(); 

            // 2. 【关键步骤】净化 HTML 代码
            // 禅道编辑器如果看到复杂的 img 属性（如 data-mce-src）可能会直接过滤掉整个图片
            // 我们需要手动把 HTML 里的 img 标签洗干净，只保留 src
            const parser = new DOMParser();
            const doc = parser.parseFromString(rawContent, 'text/html');
            const images = doc.getElementsByTagName('img');
            
            for (let i = 0; i < images.length; i++) {
                const img = images[i];
                const src = img.getAttribute('src'); // 获取 Base64
                
                // 移除所有属性
                while(img.attributes.length > 0) {
                    img.removeAttribute(img.attributes[0].name);
                }
                
                // 只加回最核心的 src，不带任何宽高样式的干扰（让禅道自己决定）
                // 也不要加 alt，尽可能纯净
                img.setAttribute('src', src);
            }
            
            // 获取净化后的 HTML 字符串
            const cleanContent = doc.body.innerHTML;

            // 简单检查
            if (cleanContent.includes('<img') && !cleanContent.includes('data:image')) {
                alert('图片数据异常，请重新截图粘贴后再试。');
            }

            // 3. 创建中转容器 (使用净化后的代码)
            const transferDiv = document.createElement('div');
            transferDiv.contentEditable = "true";
            transferDiv.style.position = 'fixed';
            transferDiv.style.left = '0';
            transferDiv.style.top = '0';
            transferDiv.style.opacity = '0.01'; 
            transferDiv.style.zIndex = '999999';
            transferDiv.style.width = '100%';
            transferDiv.style.height = '100%';
            transferDiv.style.overflow = 'hidden';
            transferDiv.style.background = 'white';
            
            // 注入净化后的内容
            transferDiv.innerHTML = cleanContent;
            document.body.appendChild(transferDiv);

            // 4. 聚焦并全选
            transferDiv.focus();
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(transferDiv);
            selection.addRange(range);

            // 5. 执行复制
            try {
                // 优先 execCommand，兼容性最好
                const successful = document.execCommand('copy');
                
                // 辅助尝试 Clipboard API (使用纯净 HTML)
                if (navigator.clipboard && navigator.clipboard.write) {
                    try {
                        const blobHtml = new Blob([cleanContent], { type: 'text/html' });
                        const blobText = new Blob([transferDiv.innerText], { type: 'text/plain' });
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'text/html': blobHtml,
                                'text/plain': blobText
                            })
                        ]);
                    } catch(e) {
                        console.warn('Clipboard API fallback error', e);
                    }
                }
                
                showToast(successful);
            } catch (err) {
                console.error('复制出错:', err);
                showToast(false);
            }

            // 6. 清理
            setTimeout(() => {
                document.body.removeChild(transferDiv);
            }, 200);
        }

        function clearEditor() {
            if(confirm('确定要清空所有内容吗？')) {
                tinymce.get('mytextarea').setContent('');
            }
        }

        function showToast(success = true) {
            const msg = document.getElementById('msg');
            if (success) {
                msg.innerText = "✅ 已生成纯净代码并复制！请去禅道粘贴";
                msg.className = "text-green-600 text-sm font-medium toast-hidden";
            } else {
                msg.innerText = "⚠️ 复制被拦截，请手动全选内容按 Ctrl+C";
                msg.className = "text-red-600 text-sm font-medium toast-hidden";
            }
            
            // 重置动画
            void msg.offsetWidth;
            msg.classList.add('toast-visible');
        }
    </script>
</body>
</html>
