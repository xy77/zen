<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禅道兼容</title>
    <!-- 引入 Tailwind CSS 进行页面布局美化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 TinyMCE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="no-referrer"></script>
    <style>
        .tox-tinymce {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        body {
            background-color: #f3f4f6;
        }
        /* 复制成功的动画 */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .toast-visible {
            opacity: 1;
            animation: fadeOut 2s ease-in-out 1s forwards;
        }
        /* 加载遮罩 */
        #loading-overlay {
            display: none;
            background: rgba(255, 255, 255, 0.8);
            z-index: 50;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <!-- 加载中提示 -->
    <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center rounded-xl">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
            <p class="text-blue-600 font-bold">正在压缩图片并生成代码...</p>
        </div>
    </div>

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style="height: 90vh;">
        <!-- 头部 -->
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-xl font-bold">禅道兼容需求编辑器</h1>
                <p class="text-blue-100 text-sm mt-1">编写内容 -> 智能压缩复制 -> 粘贴至禅道</p>
            </div>
            <div class="text-xs bg-blue-700 px-3 py-1 rounded text-blue-200">
                支持：图片自动压缩 (PNG转JPG) 以适应禅道
            </div>
        </div>

        <!-- 编辑器容器 -->
        <div class="flex-grow p-4 bg-white overflow-hidden flex flex-col">
            <textarea id="mytextarea">
                <p>在此处编写您的需求描述...</p>
                <p><strong>1. 功能点：</strong></p>
                <ul>
                    <li>支持直接截图粘贴 (Ctrl+V)</li>
                    <li>点击下方按钮会自动压缩图片体积，防止粘贴失败</li>
                </ul>
            </textarea>
        </div>

        <!-- 底部操作栏 -->
        <div class="bg-gray-50 border-t border-gray-200 p-4 shrink-0 flex justify-end items-center gap-3">
            <span id="msg" class="text-green-600 text-sm font-medium toast-hidden">
                ✅ 已压缩并复制！请去禅道粘贴
            </span>
            <button onclick="clearEditor()" class="px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors text-sm font-medium">
                清空内容
            </button>
            <button onclick="copyForZentao()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow transition-transform transform active:scale-95 font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                压缩并复制 (推荐)
            </button>
        </div>
    </div>

    <script>
        tinymce.init({
            selector: '#mytextarea',
            height: "100%", 
            resize: false,  
            branding: false, 
            statusbar: true, 
            menubar: false,  
            plugins: 'lists table image link code wordcount',
            toolbar: 'bold italic underline strikethrough | numlist bullist | table image | removeformat code',
            
            paste_data_images: true,
            automatic_uploads: false,
            images_reuse_filename: false,
            
            content_style: `
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #333; }
                table { border-collapse: collapse; width: 100%; }
                table td, table th { border: 1px solid #ccc; padding: 4px 8px; }
                img { max-width: 100%; height: auto; display: block; margin: 4px 0; }
            `,

            table_default_attributes: { border: '1', style: 'border-collapse: collapse; width: 100%; border-color: #ddd;' },
            table_default_styles: { 'border-collapse': 'collapse', 'width': '100%' }
        });

        // 将 Base64 图片转换为压缩后的 JPEG Base64
        function compressImage(imgElement) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // 1. 设置画布尺寸
                canvas.width = imgElement.naturalWidth;
                canvas.height = imgElement.naturalHeight;

                // 2. 填充白色背景 (JPEG 不支持透明，避免 PNG 透明变黑)
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 3. 绘制图片
                ctx.drawImage(imgElement, 0, 0);

                // 4. 导出为 JPEG，质量 0.7 (兼顾清晰度和体积)
                // 这一步能让 2MB 的 PNG 变成 200KB 的 JPG，极大增加禅道兼容性
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                resolve(compressedDataUrl);
            });
        }

        async function copyForZentao() {
            const editor = tinymce.get('mytextarea');
            if (!editor) return;

            // 显示 loading
            document.getElementById('loading-overlay').style.display = 'flex';

            try {
                // 1. 获取编辑器内的所有图片 DOM 节点
                // 我们直接操作 DOM，比操作字符串更准确
                const editorBody = editor.getBody();
                const images = editorBody.querySelectorAll('img');
                
                // 创建一个临时的 HTML 容器用于处理
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = editor.getContent();
                const tempImages = tempContainer.querySelectorAll('img');

                // 2. 遍历并压缩图片
                // 只有当图片是 base64 (data:image) 时才处理
                for (let i = 0; i < images.length; i++) {
                    const originalImg = images[i];
                    const tempImg = tempImages[i]; // 对应临时容器里的图片
                    
                    if (originalImg.src.startsWith('data:image')) {
                        try {
                            // 执行压缩
                            const newBase64 = await compressImage(originalImg);
                            
                            // 清洗属性：只保留 src，去除 data-mce-src 等禅道不喜欢的属性
                            // 使用压缩后的数据替换
                            tempImg.setAttribute('src', newBase64);
                            
                            // 移除其他可能导致过滤的属性
                            const attributes = Array.from(tempImg.attributes);
                            attributes.forEach(attr => {
                                if (attr.name !== 'src') {
                                    tempImg.removeAttribute(attr.name);
                                }
                            });
                        } catch (err) {
                            console.error('压缩图片失败，保留原图:', err);
                        }
                    }
                }

                // 3. 获取处理后的 HTML
                const cleanContent = tempContainer.innerHTML;

                // 4. 执行原生的复制流程
                await executeCopy(cleanContent);
                
            } catch (error) {
                console.error('处理流程出错:', error);
                alert('处理出错，请重试');
            } finally {
                // 隐藏 loading
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        async function executeCopy(htmlContent) {
            // 创建中转容器
            const transferDiv = document.createElement('div');
            transferDiv.contentEditable = "true";
            // 样式设置：保证不可见但可被选中
            transferDiv.style.position = 'fixed';
            transferDiv.style.left = '0';
            transferDiv.style.top = '0';
            transferDiv.style.opacity = '0.01'; 
            transferDiv.style.zIndex = '999999';
            transferDiv.style.width = '100%';
            transferDiv.style.height = '100%';
            transferDiv.style.overflow = 'hidden';
            transferDiv.style.background = 'white';
            
            // 注入内容
            transferDiv.innerHTML = htmlContent;
            document.body.appendChild(transferDiv);

            // 聚焦并全选
            transferDiv.focus();
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(transferDiv);
            selection.addRange(range);

            try {
                // 优先使用 execCommand
                const successful = document.execCommand('copy');
                
                // 尝试 Clipboard API 兜底
                if (navigator.clipboard && navigator.clipboard.write) {
                    try {
                        const blobHtml = new Blob([htmlContent], { type: 'text/html' });
                        const blobText = new Blob([transferDiv.innerText], { type: 'text/plain' });
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'text/html': blobHtml,
                                'text/plain': blobText
                            })
                        ]);
                    } catch(e) {}
                }
                
                showToast(successful);
            } catch (err) {
                showToast(false);
            }

            // 移除容器
            setTimeout(() => {
                document.body.removeChild(transferDiv);
            }, 200);
        }

        function clearEditor() {
            if(confirm('确定要清空所有内容吗？')) {
                tinymce.get('mytextarea').setContent('');
            }
        }

        function showToast(success = true) {
            const msg = document.getElementById('msg');
            if (success) {
                msg.innerText = "✅ 已压缩优化并复制！请去禅道粘贴";
                msg.className = "text-green-600 text-sm font-medium toast-hidden";
            } else {
                msg.innerText = "⚠️ 复制被拦截，请手动全选内容按 Ctrl+C";
                msg.className = "text-red-600 text-sm font-medium toast-hidden";
            }
            
            void msg.offsetWidth;
            msg.classList.add('toast-visible');
        }
    </script>
</body>
</html>
