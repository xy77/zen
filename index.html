<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禅道2</title>
    <!-- 引入 Tailwind CSS 进行页面布局美化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 TinyMCE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="no-referrer"></script>
    <style>
        .tox-tinymce {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        body {
            background-color: #f3f4f6;
        }
        /* 复制成功的动画 */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .toast-visible {
            opacity: 1;
            animation: fadeOut 2s ease-in-out 1s forwards;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style="height: 90vh;">
        <!-- 头部 -->
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-xl font-bold">禅道兼容需求编辑器</h1>
                <p class="text-blue-100 text-sm mt-1">编写内容 -> 一键全选复制 -> 粘贴至禅道</p>
            </div>
            <div class="text-xs bg-blue-700 px-3 py-1 rounded text-blue-200">
                支持：加粗/斜体/下划线/删除线/列表/表格/贴图
            </div>
        </div>

        <!-- 编辑器容器 -->
        <div class="flex-grow p-4 bg-white overflow-hidden flex flex-col">
            <textarea id="mytextarea">
                <p>在此处编写您的需求描述...</p>
                <p><strong>1. 功能点：</strong></p>
                <ul>
                    <li>支持直接截图粘贴 (Ctrl+V)</li>
                    <li>支持表格和列表</li>
                </ul>
            </textarea>
        </div>

        <!-- 底部操作栏 -->
        <div class="bg-gray-50 border-t border-gray-200 p-4 shrink-0 flex justify-end items-center gap-3">
            <span id="msg" class="text-green-600 text-sm font-medium toast-hidden">
                ✅ 已全选并尝试复制！如果粘贴无图，请手动按 Ctrl+C
            </span>
            <button onclick="clearEditor()" class="px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors text-sm font-medium">
                清空内容
            </button>
            <button onclick="copyForZentao()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow transition-transform transform active:scale-95 font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                全选并复制
            </button>
        </div>
    </div>

    <script>
        tinymce.init({
            selector: '#mytextarea',
            height: "100%", 
            resize: false,  
            branding: false, 
            statusbar: true, 
            menubar: false,  
            plugins: 'lists table image link code wordcount',
            toolbar: 'bold italic underline strikethrough | numlist bullist | table image | removeformat code',
            
            // 核心配置：确保图片保留为 Base64
            paste_data_images: true,
            automatic_uploads: false,
            images_reuse_filename: false,
            // 防止 TinyMCE 自动将 base64 转换为 blob url (虽然能提升性能，但会影响复制)
            images_dataimg_filter: function(img) {
                return img.hasAttribute('internal-blob'); 
            },
            
            content_style: `
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #333; }
                table { border-collapse: collapse; width: 100%; }
                table td, table th { border: 1px solid #ccc; padding: 4px 8px; }
                img { max-width: 100%; height: auto; display: block; margin: 4px 0; }
            `,

            table_default_attributes: { border: '1', style: 'border-collapse: collapse; width: 100%; border-color: #ddd;' },
            table_default_styles: { 'border-collapse': 'collapse', 'width': '100%' }
        });

        async function copyForZentao() {
            const editor = tinymce.get('mytextarea');
            if (!editor) return;

            // 1. 强制刷新内容：将所有 Blob URL 转换为真实的 Base64 数据
            // TinyMCE 内部通常用 blob 预览，getContent 会返回 base64，我们这里把 DOM 也强刷成 base64
            const content = editor.getContent(); 
            editor.setContent(content); 

            // 2. 聚焦编辑器并全选
            editor.focus();
            editor.selection.select(editor.getBody());

            // 3. 尝试浏览器原生复制 (在 iframe 内执行)
            // 这是最稳妥的方式，相当于你在 Word 里按了 Ctrl+A 然后 Ctrl+C
            try {
                const successful = editor.getDoc().execCommand('copy');
                
                // 4. 双重保障：如果原生复制没报错，我们也尝试用 Clipboard API 写入剪贴板
                // 这样既照顾了旧浏览器，也照顾了新浏览器的 MIME 类型
                if (navigator.clipboard && navigator.clipboard.write) {
                    const blobHtml = new Blob([content], { type: 'text/html' });
                    const blobText = new Blob([editor.getContent({format: 'text'})], { type: 'text/plain' });
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            'text/html': blobHtml,
                            'text/plain': blobText
                        })
                    ]);
                }
                
                showToast(successful);
            } catch (err) {
                console.error('Copy failed:', err);
                // 即使脚本复制失败，因为内容已经被选中了，用户手动按 Ctrl+C 也能成功
                showToast(false);
            }
        }

        function clearEditor() {
            if(confirm('确定要清空所有内容吗？')) {
                tinymce.get('mytextarea').setContent('');
            }
        }

        function showToast(autoCopied = true) {
            const msg = document.getElementById('msg');
            if (autoCopied) {
                msg.innerText = "✅ 已全选并复制！请去禅道粘贴";
            } else {
                msg.innerText = "⚠️ 自动复制失败，内容已全选，请手动按 Ctrl+C";
            }
            
            // 重置动画
            msg.classList.remove('toast-visible');
            void msg.offsetWidth; // 触发重绘
            msg.classList.add('toast-visible');
        }
    </script>
</body>
</html>
