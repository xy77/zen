<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>禅道兼容需求编辑器</title>
    <!-- 引入 Tailwind CSS 进行页面布局美化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 TinyMCE (开源且强大的富文本编辑器) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="no-referrer"></script>
    <style>
        /* 针对编辑器的微调，模仿禅道的输入区域感 */
        .tox-tinymce {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        /* 页面背景 */
        body {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col" style="height: 90vh;">
        <!-- 头部 -->
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-xl font-bold">禅道兼容需求编辑器</h1>
                <p class="text-blue-100 text-sm mt-1">编写内容 -> 一键复制 -> 粘贴至禅道</p>
            </div>
            <div class="text-xs bg-blue-700 px-3 py-1 rounded text-blue-200">
                支持：加粗/斜体/下划线/删除线/列表/表格/贴图
            </div>
        </div>

        <!-- 编辑器容器 -->
        <div class="flex-grow p-4 bg-white overflow-hidden flex flex-col">
            <textarea id="mytextarea">
                <p>在此处编写您的需求描述...</p>
                <p><strong>1. 功能点：</strong></p>
                <ul>
                    <li>支持直接截图粘贴 (Ctrl+V)</li>
                    <li>支持表格和列表</li>
                </ul>
            </textarea>
        </div>

        <!-- 底部操作栏 -->
        <div class="bg-gray-50 border-t border-gray-200 p-4 shrink-0 flex justify-end items-center gap-3">
            <span id="msg" class="text-green-600 text-sm font-medium opacity-0 transition-opacity duration-300">
                ✅ 内容已复制到剪贴板！
            </span>
            <button onclick="clearEditor()" class="px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors text-sm font-medium">
                清空内容
            </button>
            <button onclick="copyForZentao()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow transition-transform transform active:scale-95 font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                一键复制内容
            </button>
        </div>
    </div>

    <script>
        // 初始化 TinyMCE 编辑器
        tinymce.init({
            selector: '#mytextarea',
            height: "100%", 
            resize: false,  
            branding: false, 
            statusbar: true, 
            menubar: false,  
            
            plugins: 'lists table image link code wordcount',

            // 关键配置：工具栏
            toolbar: 'bold italic underline strikethrough | numlist bullist | table image | removeformat code',

            // 图片处理关键配置
            paste_data_images: true, // 允许粘贴图片生成 base64
            automatic_uploads: false, // 禁止自动上传（这会强制图片保持 base64 格式）
            images_reuse_filename: false,
            
            content_style: `
                body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; color: #333; }
                table { border-collapse: collapse; width: 100%; }
                table td, table th { border: 1px solid #ccc; padding: 4px 8px; }
                img { max-width: 100%; height: auto; }
            `,

            table_default_attributes: {
                border: '1',
                style: 'border-collapse: collapse; width: 100%; border-color: #ddd;'
            },
            table_default_styles: {
                'border-collapse': 'collapse',
                'width': '100%'
            }
        });

        // 强力复制功能 - 针对禅道优化
        async function copyForZentao() {
            const editor = tinymce.get('mytextarea');
            if (!editor) return;

            // 1. 获取完整的 HTML 内容
            const content = editor.getContent();

            // 策略 A: 尝试使用现代 Clipboard API (支持更好的 MIME 类型处理)
            // 注意：这通常需要 https 或 localhost 环境，在 file:// 协议下可能失败
            if (navigator.clipboard && navigator.clipboard.write && window.isSecureContext) {
                try {
                    const blobHtml = new Blob([content], { type: 'text/html' });
                    const blobText = new Blob([editor.getContent({format: 'text'})], { type: 'text/plain' });
                    
                    const data = [new ClipboardItem({
                        'text/html': blobHtml,
                        'text/plain': blobText
                    })];
                    
                    await navigator.clipboard.write(data);
                    showToast();
                    return; // 如果成功，直接结束
                } catch (err) {
                    console.log('Clipboard API 尝试失败，切换到回退方案:', err);
                    // 失败后继续执行下方的 fallback 方案
                }
            }

            // 策略 B: 兼容性更强的 DOM 模拟复制 (修复了图片渲染问题)
            
            // 创建一个"透明但存在于布局中"的容器
            // 关键修改：不再使用 left: -9999px，因为这会导致浏览器忽略图片渲染
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'fixed';
            tempDiv.style.top = '0';
            tempDiv.style.left = '0';
            tempDiv.style.width = '800px'; // 给定足够宽度以确保布局正常
            tempDiv.style.opacity = '0';   // 透明不可见
            tempDiv.style.pointerEvents = 'none'; // 鼠标穿透
            tempDiv.style.zIndex = '-9999'; // 置于最底层
            tempDiv.style.overflow = 'hidden';
            tempDiv.style.height = '1px';
            
            // 注入内容
            tempDiv.innerHTML = content;
            document.body.appendChild(tempDiv);

            // 强制浏览器"重绘"一下，确保图片被加载
            // 虽然是同步代码，但在 DOM 树中存在通常足以触发 Image 对象的创建
            
            // 选中
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(tempDiv);
            selection.removeAllRanges();
            selection.addRange(range);

            // 执行复制
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast();
                } else {
                    alert('浏览器拒绝了复制请求，请尝试手动全选内容复制 (Ctrl+A, Ctrl+C)');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                alert('复制发生错误');
            }

            // 清理现场
            selection.removeAllRanges();
            // 稍微延迟移除，给浏览器一点处理时间
            setTimeout(() => {
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
            }, 100);
        }

        function clearEditor() {
            if(confirm('确定要清空所有内容吗？')) {
                tinymce.get('mytextarea').setContent('');
            }
        }

        function showToast() {
            const msg = document.getElementById('msg');
            msg.style.opacity = '1';
            setTimeout(() => {
                msg.style.opacity = '0';
            }, 2000);
        }
    </script>
</body>
</html>
